# 啸叫抑制使用指南

## 概述
本VoIP客户端集成了多种啸叫抑制技术，帮助您获得更清晰的语音通话体验。

## 啸叫原因
啸叫（反馈）通常发生在以下情况：
- 麦克风距离扬声器太近
- 音量设置过高
- 房间声学环境不佳（回声严重）
- 缺乏音频处理技术

## 抑制技术

### 1. 回声消除 (Echo Cancellation)
- **功能**: 自动识别并消除从扬声器传到麦克风的声音
- **原理**: 使用自适应滤波器算法，比较输入和输出音频
- **建议**: 默认开启，特别适用于近距离通话

### 2. 噪声抑制 (Noise Suppression)
- **功能**: 使用噪声门技术减少背景噪音
- **原理**: 当音量低于阈值时自动衰减信号
- **建议**: 在嘈杂环境中开启

### 3. 自动增益控制 (Auto Gain Control)
- **功能**: 自动调整音频增益，保持音量稳定
- **原理**: 动态调整信号强度，防止音量过高或过低
- **建议**: 始终开启以获得稳定的音量

### 4. 语音活动检测 (Voice Activity Detection)
- **功能**: 只在检测到语音时发送音频数据
- **原理**: 基于能量和过零率检测语音活动
- **建议**: 开启以减少无效音频传输

## 配置参数

### 音量设置
- **输入音量**: 0.7 (推荐值，范围0.0-1.0)
- **输出音量**: 0.8 (推荐值，范围0.0-1.0)

### 噪声门阈值
- **默认值**: 0.01
- **调整建议**: 
  - 噪声环境多：增加到0.02-0.05
  - 安静环境：降低到0.005-0.01

### 高级参数
- **回声延迟采样数**: 1024 (适合大部分场景)
- **历史帧数**: 10 (回声消除用)
- **目标RMS**: 3000.0 (AGC目标值)

## 使用方法

### 运行时调整
在客户端命令行中输入：
```
audio
```
进入音频设置菜单，可以实时调整各项参数。

### 配置文件
编辑 `audio_config.json` 文件来保存您的偏好设置。

## 优化建议

### 硬件优化
1. **使用耳机**: 这是最有效的防啸叫方法
2. **调整音量**: 保持适中的音量水平
3. **麦克风位置**: 远离扬声器，朝向嘴部
4. **房间布置**: 增加软质材料减少回声

### 软件优化
1. **启用所有抑制功能**: 回声消除、噪声抑制、AGC、VAD
2. **调整音量**: 输入音量0.7，输出音量0.8
3. **根据环境调整噪声门**: 嘈杂环境提高阈值
4. **使用低延迟模式**: 减少音频缓冲延迟

### 场景优化

#### 办公室环境
```json
{
  "echo_cancellation": true,
  "noise_suppression": true,
  "auto_gain_control": true,
  "voice_activity_detection": true,
  "input_volume": 0.6,
  "output_volume": 0.7,
  "noise_gate_threshold": 0.02
}
```

#### 家庭环境
```json
{
  "echo_cancellation": true,
  "noise_suppression": false,
  "auto_gain_control": true,
  "voice_activity_detection": false,
  "input_volume": 0.8,
  "output_volume": 0.9,
  "noise_gate_threshold": 0.005
}
```

#### 会议室
```json
{
  "echo_cancellation": true,
  "noise_suppression": true,
  "auto_gain_control": true,
  "voice_activity_detection": true,
  "input_volume": 0.5,
  "output_volume": 0.6,
  "noise_gate_threshold": 0.03
}
```

## 故障排除

### 仍有啸叫
1. 降低输入/输出音量
2. 增加噪声门阈值
3. 检查硬件连接
4. 使用耳机

### 声音断断续续
1. 降低噪声门阈值
2. 关闭语音活动检测
3. 检查网络连接

### 声音延迟
1. 减小chunk_size
2. 启用低延迟模式
3. 检查系统负载

## 技术原理

### 自适应滤波器
回声消除使用LMS（最小均方）算法的简化版本：
- 比较输入信号与参考信号（输出历史）
- 当相关性高时自动衰减输入信号
- 自适应调整滤波器参数

### 语音活动检测
结合能量检测和过零率分析：
- 能量阈值: 检测信号强度
- 过零率: 检测信号频率特征
- 双重判断提高准确性

### 自动增益控制
基于RMS值的动态增益调整：
- 计算当前信号RMS值
- 与目标值比较计算增益
- 应用限制防止过度放大

## 性能影响
- 启用所有功能约增加10-15%CPU使用率
- numpy处理比纯Python快5-10倍
- 建议在性能较弱设备上选择性启用功能
